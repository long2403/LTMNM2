<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat vÃ  Gá»i Video</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ¤ Chat & Video Call</h1>
            <p>á»¨ng dá»¥ng chat vÃ  gá»i video thá»i gian thá»±c</p>
        </header>
        <!-- Fallback náº¿u chÆ°a login -->
        <div id="authFallback" class="auth-section full-width" style="display: none;">
            <h2>ğŸ” Vui lÃ²ng Ä‘Äƒng nháº­p</h2>
            <p><a href="/login">Äi Ä‘áº¿n trang Ä‘Äƒng nháº­p</a></p>
            <button onclick="window.location.href='/login'" class="call-button">ÄÄƒng Nháº­p</button>
        </div>
        <div id="mainContent" class="main-grid" style="display: none;">
            <div class="content-grid">
                <div class="chat-section">
                    <h2>ğŸ’¬ Chat Room</h2>
                    <div class="room-controls">
                        <input type="text" id="roomInput" placeholder="Nháº­p tÃªn phÃ²ng (máº·c Ä‘á»‹nh: general)">
                        <button onclick="joinRoom()">Tham gia</button>
                        <button id="leaveRoomBtn" onclick="leaveRoom()" style="display: none; background: #dc3545;">ğŸšª Rá»i PhÃ²ng</button>
                        <span id="currentRoomSpan" style="color: #667eea; font-weight: 500; margin-left: auto;"></span>
                    </div>
                    <div id="chatBox"></div>
                    <div class="message-controls">
                        <input type="text" id="messageInput" placeholder="Nháº­p tin nháº¯n..." onkeypress="if(event.key==='Enter') sendMessage()">
                        <button onclick="sendMessage()">Gá»­i</button>
                        <input type="file" id="fileInput" accept="image/*">
                        <button onclick="sendFile()">ğŸ“ File</button>
                    </div>
                </div>
                <div class="video-section">
    <h2>ğŸ“¹ Gá»i Video</h2>
    <div class="video-container">
        <video id="localVideo" autoplay muted class="video-local"></video>
        <video id="remoteVideo" autoplay class="video-remote"></video>
    </div>
    <div class="toggle-controls" id="toggleControls" style="display: none;">
        <button onclick="toggleCamera()" id="cameraBtn" class="toggle-btn">ğŸ“·</button>
        <button onclick="toggleMic()" id="micBtn" class="toggle-btn">ğŸ¤</button>
    </div>
    
    <!-- NÃºt gá»i -->
    <button onclick="startCall()" id="startCallBtn" class="call-button">ğŸ“ Báº¯t Ä‘áº§u Gá»i</button>
    
    <!-- NÃºt káº¿t thÃºc gá»i (hiá»‡n khi Ä‘ang gá»i) -->
    <button onclick="endCall()" id="endCallBtn" class="call-button" style="display:none; background: #ff6b6b;">ğŸ“ Káº¿t thÃºc</button>
    
    <!-- NÃºt cháº¥p nháº­n/tá»« chá»‘i (hiá»‡n khi cÃ³ incoming call) -->
    <div id="incomingCallControls" class="button-group" style="display: none; justify-content: center; gap: 20px; margin: 10px 0;">
        <button onclick="acceptCall()" class="call-button" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); flex: 0 1 120px;">âœ… Cháº¥p nháº­n</button>
        <button onclick="rejectCall()" class="call-button" style="background: #dc3545; flex: 0 1 120px;">âŒ Tá»« chá»‘i</button>
    </div>
    
    <button onclick="logout()" class="call-button" style="background: #6c757d;">ğŸšª ÄÄƒng Xuáº¥t</button>
</div>



<div class="game-menu">
    <button onclick="toggleGame('rpsSection')">ğŸ® Oáº³n TÃ¹ TÃ¬</button>
    <button onclick="toggleGame('flappySection')">ğŸ¦ Flappy Bird</button>
</div>

                <!-- Pháº§n Game RPS -->

                <!-- Pháº§n Game Flappy Bird -->
<div class="game-section" id="flappySection" style="display: none;">
    <h2>ğŸ¦ Flappy Bird Mini</h2>
    <canvas id="flappyCanvas" width="320" height="480" style="border:2px solid #333; background:#70c5ce;"></canvas>
    <div style="margin-top: 10px;">
        <button onclick="startFlappy()">â–¶ï¸ Báº¯t Ä‘áº§u</button>
        <button onclick="stopFlappy()">â¹ï¸ Dá»«ng</button>
        <button onclick="resetFlappy()">ğŸ”„ ChÆ¡i láº¡i</button>
    </div>
    <div id="flappyScore" style="margin-top:10px; font-weight:bold; color:#333;"></div>
</div>


                <div class="game-section" id="rpsSection" style="display: none;">
                    <h2>ğŸ® KÃ©o BÃºa Bao</h2>
                    <div class="rps-choices">
                        <button class="rps-choice-btn" onclick="sendRPSChoice('rock')" title="KÃ©o">âœŠ</button>
                        <button class="rps-choice-btn" onclick="sendRPSChoice('paper')" title="BÃºa">âœ‹</button>
                        <button class="rps-choice-btn" onclick="sendRPSChoice('scissors')" title="Bao">âœŒï¸</button>
                    </div>
                    <div id="rpsResult" style="display: none;"></div>
                    <button onclick="updateRPSUI()" class="call-button" style="width: 100%; margin-top: 10px; background: #6c757d;" id="resetRPSBtn" style="display: none;">ğŸ”„ ChÆ¡i Láº¡i</button>
                </div>
            </div>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="client.js"></script>
    <script>
        // Kiá»ƒm tra login khi load
        window.addEventListener('load', () => {
            const token = localStorage.getItem('token');
            if (!token) {
                document.getElementById('authFallback').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
            } else {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    window.sender = payload.username;
                    localStorage.setItem('username', payload.username); // LÆ°u username
                } catch (e) {
                    localStorage.removeItem('token');
                    window.location.href = '/login';
                    return;
                }
                document.getElementById('authFallback').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            }
        });

        function logout() {
            localStorage.clear();
            window.location.href = '/login';
        }
    </script>

    <script>
let flappyCanvas, ctx, birdY, birdVY, pipes, score, gameLoop, isRunning;

function initFlappy() {
    flappyCanvas = document.getElementById("flappyCanvas");
    ctx = flappyCanvas.getContext("2d");
    resetFlappy();
}

function startFlappy() {
    if (isRunning) return;
    isRunning = true;
    gameLoop = setInterval(updateFlappy, 30);
    flappyCanvas.addEventListener("click", flap);
}

function stopFlappy() {
    isRunning = false;
    clearInterval(gameLoop);
    flappyCanvas.removeEventListener("click", flap);
}

function resetFlappy() {
    birdY = 200;
    birdVY = 0;
    pipes = [];
    score = 0;
    isRunning = false;
    document.getElementById("flappyScore").innerText = "Äiá»ƒm: 0";
    clearInterval(gameLoop);
    drawFlappy();
}

function flap() {
    birdVY = -6;
}

function updateFlappy() {
    birdVY += 0.4;
    birdY += birdVY;
    if (birdY < 0 || birdY > flappyCanvas.height) return gameOverFlappy();

    // á»ng má»›i
    if (pipes.length === 0 || pipes[pipes.length - 1].x < 200) {
        const topH = Math.random() * 200 + 50;
        pipes.push({ x: 320, top: topH });
    }

    pipes.forEach(p => p.x -= 3);
    if (pipes[0].x < -50) pipes.shift();

    // Va cháº¡m
    pipes.forEach(p => {
        if (p.x < 60 && p.x + 50 > 40) {
            if (birdY < p.top || birdY > p.top + 120) gameOverFlappy();
        }
        if (p.x === 37) score++;
    });

    drawFlappy();
}

function drawFlappy() {
    ctx.fillStyle = "#70c5ce";
    ctx.fillRect(0, 0, 320, 480);

    // á»ng
    ctx.fillStyle = "#228B22";
    pipes.forEach(p => {
        ctx.fillRect(p.x, 0, 50, p.top);
        ctx.fillRect(p.x, p.top + 120, 50, 480);
    });

    // Chim
    ctx.fillStyle = "yellow";
    ctx.beginPath();
    ctx.arc(50, birdY, 10, 0, Math.PI * 2);
    ctx.fill();

    // Äiá»ƒm
    document.getElementById("flappyScore").innerText = "Äiá»ƒm: " + score;
}

function gameOverFlappy() {
    stopFlappy();
    alert("ğŸ¦ Game Over! Äiá»ƒm cá»§a báº¡n: " + score);
}
window.addEventListener('load', initFlappy);
</script>


<script>
function toggleGame(sectionId) {
    document.getElementById("rpsSection").style.display = "none";
    document.getElementById("flappySection").style.display = "none";
    document.getElementById(sectionId).style.display = "block";
}
</script>



</body>
</html>